-- SUPER FLING GUI | WORKING TARGET DROPDOWN + REAL PREDICTION

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Stats = game:GetService("Stats")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- ================== CONFIG ==================
local BASE_PREDICTION = 0.18
local MAX_PREDICTION = 0.4
local SNAP_DISTANCE = 45

-- ================== STATE ==================
local selectedPlayer = nil
local selectedUserId = nil
local flingMode = "Orbit" -- Orbit | Fast | Direct
local cameraLock = false
local predictionStrength = BASE_PREDICTION

-- ================== GUI ==================
local gui = Instance.new("ScreenGui", PlayerGui)
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 280, 0, 440)
frame.Position = UDim2.new(0, 10, 0.35, 0)
frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
Instance.new("UICorner", frame)

local function button(text, y)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.new(1,-20,0,26)
	b.Position = UDim2.new(0,10,0,y)
	b.BackgroundColor3 = Color3.fromRGB(55,55,55)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.SourceSans
	b.TextSize = 14
	b.Text = text
	return b
end

local toggleBtn = button("Start Fling", 10)
toggleBtn.BackgroundColor3 = Color3.fromRGB(0,170,255)

local targetBtn = button("Select Target ▼", 45)

local dropdown = Instance.new("ScrollingFrame", frame)
dropdown.Position = UDim2.new(0,10,0,75)
dropdown.Size = UDim2.new(1,-20,0,130)
dropdown.BackgroundColor3 = Color3.fromRGB(40,40,40)
dropdown.ScrollBarThickness = 6
dropdown.Visible = false
dropdown.CanvasSize = UDim2.new(0,0,0,0)

local layout = Instance.new("UIListLayout", dropdown)
layout.Padding = UDim.new(0,4)

local modeBtn = button("Mode: Orbit", 215)
local predBtn = button("Prediction: 0.18", 245)
local camBtn = button("Camera Lock: OFF", 275)

local status = Instance.new("TextLabel", frame)
status.Size = UDim2.new(1,-20,0,20)
status.Position = UDim2.new(0,10,0,310)
status.BackgroundTransparency = 1
status.TextColor3 = Color3.new(1,1,1)
status.TextXAlignment = Enum.TextXAlignment.Left
status.Font = Enum.Font.SourceSans
status.TextSize = 14
status.Text = "Status: Idle"

local distLabel = status:Clone()
distLabel.Position = UDim2.new(0,10,0,330)
distLabel.Text = "Distance: N/A"
distLabel.Parent = frame

-- ================== UTILS ==================
local function getPing()
	local ping = Stats.Network.ServerStatsItem["Data Ping"]:GetValue()
	return math.clamp(ping / 1000, 0.06, 0.25)
end

-- REAL MOVEMENT PREDICTION
local function predictPosition(hrp, dt)
	local vel = hrp.AssemblyLinearVelocity
	local pingLead = getPing()

	-- Horizontal lead
	local horizontalVel = Vector3.new(vel.X, 0, vel.Z)
	local predicted = hrp.Position + horizontalVel * (predictionStrength + pingLead)

	-- Vertical handling (jump/fall)
	predicted += Vector3.new(0, math.clamp(vel.Y * 0.15, -6, 6), 0)

	return predicted
end

-- ================== DROPDOWN ==================
local function refreshDropdown()
	for _, c in ipairs(dropdown:GetChildren()) do
		if c:IsA("TextButton") then c:Destroy() end
	end

	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			local b = Instance.new("TextButton", dropdown)
			b.Size = UDim2.new(1,-6,0,26)
			b.Text = p.Name
			b.BackgroundColor3 = Color3.fromRGB(65,65,65)
			b.TextColor3 = Color3.new(1,1,1)
			b.Font = Enum.Font.SourceSans
			b.TextSize = 14

			b.MouseButton1Click:Connect(function()
				selectedPlayer = p
				selectedUserId = p.UserId
				targetBtn.Text = "Target: "..p.Name.." ▼"
				dropdown.Visible = false
				status.Text = "Status: Target Locked"
			end)
		end
	end

	dropdown.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y)
end

targetBtn.MouseButton1Click:Connect(function()
	dropdown.Visible = not dropdown.Visible
	refreshDropdown()
end)

Players.PlayerRemoving:Connect(function(p)
	if selectedUserId and p.UserId == selectedUserId then
		selectedPlayer = nil
		status.Text = "Status: Waiting for target"
	end
end)

Players.PlayerAdded:Connect(function(p)
	if selectedUserId and p.UserId == selectedUserId then
		selectedPlayer = p
		status.Text = "Status: Target Rejoined"
	end
end)

-- ================== CONTROLS ==================
modeBtn.MouseButton1Click:Connect(function()
	if flingMode == "Orbit" then
		flingMode = "Fast"
	elseif flingMode == "Fast" then
		flingMode = "Direct"
	else
		flingMode = "Orbit"
	end
	modeBtn.Text = "Mode: "..flingMode
end)

predBtn.MouseButton1Click:Connect(function()
	predictionStrength += 0.05
	if predictionStrength > MAX_PREDICTION then
		predictionStrength = BASE_PREDICTION
	end
	predBtn.Text = string.format("Prediction: %.2f", predictionStrength)
end)

camBtn.MouseButton1Click:Connect(function()
	cameraLock = not cameraLock
	camBtn.Text = "Camera Lock: "..(cameraLock and "ON" or "OFF")
end)

-- ================== FLING CORE ==================
local flingConn
toggleBtn.MouseButton1Click:Connect(function()
	if flingConn then
		flingConn:Disconnect()
		flingConn = nil
		toggleBtn.Text = "Start Fling"
		status.Text = "Status: Stopped"
		Camera.CameraSubject = LocalPlayer.Character:FindFirstChild("Humanoid")
		return
	end

	if not selectedUserId then
		status.Text = "Status: No target selected"
		return
	end

	local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart")

	toggleBtn.Text = "Stop Fling"
	status.Text = "Status: Flinging ("..flingMode..")"

	flingConn = RunService.Heartbeat:Connect(function(dt)
		if not selectedPlayer then
			for _, p in ipairs(Players:GetPlayers()) do
				if p.UserId == selectedUserId then
					selectedPlayer = p
				end
			end
			return
		end

		local tch = selectedPlayer.Character
		if not tch then return end
		local thrp = tch:FindFirstChild("HumanoidRootPart")
		if not thrp then return end

		local predicted = predictPosition(thrp, dt)
		local dist = (predicted - hrp.Position).Magnitude

		if dist > SNAP_DISTANCE then
			hrp.CFrame = CFrame.new(predicted)
		end

		local t = tick()
		local offset, speed

		if flingMode == "Orbit" then
			offset = Vector3.new(math.cos(t)*5, 0, math.sin(t)*5)
			speed = 230
		elseif flingMode == "Fast" then
			offset = Vector3.new(math.cos(t*3)*7, 0, math.sin(t*3)*7)
			speed = 340
		else -- Direct
			offset = Vector3.zero
			speed = 420
		end

		char:PivotTo(CFrame.new(predicted + offset))
		hrp.AssemblyAngularVelocity = Vector3.new(9999,9999,9999)
		hrp.AssemblyLinearVelocity = (predicted - hrp.Position).Unit * speed

		if cameraLock then
			Camera.CameraSubject = thrp
			Camera.CFrame = CFrame.new(Camera.CFrame.Position, predicted)
		end

		distLabel.Text = string.format("Distance: %.1f studs", dist)
	end)
end)
