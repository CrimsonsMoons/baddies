-- =========================
-- SMART FLING LOGIC (UPGRADED)
-- =========================

local flingConn, charConn
local orbitAngle = 0

-- === Target Utilities ===
local function getTargetHRP(player)
	if not player then return nil end
	local char = player.Character
	if not char then return nil end
	return char:FindFirstChild("HumanoidRootPart")
end

local function isTargetValid(player)
	if not player then return false end
	local char = player.Character
	if not char then return false end

	local hum = char:FindFirstChildOfClass("Humanoid")
	local hrp = char:FindFirstChild("HumanoidRootPart")

	return hum and hum.Health > 0 and hrp and hrp:IsDescendantOf(workspace)
end

local function getNearestPlayer()
	local myChar = LocalPlayer.Character
	if not myChar then return nil end
	local myHRP = myChar:FindFirstChild("HumanoidRootPart")
	if not myHRP then return nil end

	local closest, minDist = nil, math.huge
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer and isTargetValid(plr) then
			local hrp = getTargetHRP(plr)
			local d = (hrp.Position - myHRP.Position).Magnitude
			if d < minDist then
				minDist = d
				closest = plr
			end
		end
	end
	return closest
end

-- === Start Fling ===
local function startFling()
	if not selectedPlayer then
		statusLabel.Text = "Status: No player selected"
		return
	end

	local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart")
	orbitAngle = 0

	statusLabel.Text = "Status: Flinging " .. selectedPlayer.Name

	-- Camera Lock
	if cameraLock then
		cameraConn = RunService.RenderStepped:Connect(function()
			local targetHRP = getTargetHRP(selectedPlayer)
			if targetHRP then
				Camera.CameraSubject = targetHRP
				Camera.CFrame = CFrame.new(Camera.CFrame.Position, targetHRP.Position)
			end
		end)
	end

	-- Respawn Re-lock
	selectedPlayer.CharacterAdded:Connect(function()
		task.wait(0.25)
		statusLabel.Text = "Status: Re-locking target"
	end)

	flingConn = RunService.Heartbeat:Connect(function(dt)
		-- Validate / fallback
		if not isTargetValid(selectedPlayer) then
			selectedPlayer = getNearestPlayer()
			if not selectedPlayer then
				statusLabel.Text = "Status: No valid targets"
				return
			end
			statusLabel.Text = "Status: Switched to " .. selectedPlayer.Name
		end

		local targetHRP = getTargetHRP(selectedPlayer)
		if not targetHRP then return end

		-- Orbit math
		local speed = tonumber(speedSlider.Text) or 1500
		orbitAngle += math.rad(speed) * dt

		-- Predict movement
		local predictedPos = targetHRP.Position + (targetHRP.AssemblyLinearVelocity * 0.12)

		local radius = 5
		local offset = Vector3.new(
			math.cos(orbitAngle) * radius,
			0,
			math.sin(orbitAngle) * radius
		)

		local desiredCFrame = CFrame.new(predictedPos + offset)
		char:PivotTo(desiredCFrame)

		-- Force fling physics
		hrp.AssemblyAngularVelocity = Vector3.new(9999, 9999, 9999)
		hrp.AssemblyLinearVelocity =
			(predictedPos - hrp.Position).Unit * 220

		-- Drift correction
		local dist = (targetHRP.Position - hrp.Position).Magnitude
		if dist > 25 then
			hrp.CFrame = CFrame.new(predictedPos + offset)
		end

		-- UI updates
		detailsLabel.Text = string.format("Distance: %.1f studs", dist)
	end)

	charConn = LocalPlayer.CharacterAdded:Connect(startFling)
end

-- === Toggle Button ===
toggleBtn.MouseButton1Click:Connect(function()
	if flingConn then
		flingConn:Disconnect()
		flingConn = nil

		if charConn then charConn:Disconnect() end
		if cameraConn then cameraConn:Disconnect() cameraConn = nil end

		Camera.CameraSubject = LocalPlayer.Character:FindFirstChild("Humanoid")
		statusLabel.Text = "Status: Stopped"
		detailsLabel.Text = "Distance: N/A"
		toggleBtn.Text = "Start Fling"
	else
		startFling()
		toggleBtn.Text = "Stop Fling"
	end
end)
